{% extends 'base.html' %}
{% load static %}

{% block title %}Appointment Details - TIP MDS EMR{% endblock %}

{% block content %}
<div class="dashboard active">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <div class="sidebar-logo-text">
                    <h2>TIP MDS EMR</h2>
                    <p>Healthcare Management</p>
                </div>
            </div>
        </div>

        <ul class="nav-menu">
            <li class="nav-item">
                <a class="nav-link" href="{% url 'doctors:dashboard' %}">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'doctors:search' %}">
                    <i class="fas fa-search"></i>
                    <span>Student Records</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'doctors:pending' %}">
                    <i class="fas fa-clock"></i>
                    <span>Pending Requests</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="{% url 'doctors:appointments' %}">
                    <i class="fas fa-calendar"></i>
                    <span>Appointments</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'doctors:templates' %}">
                    <i class="fas fa-file-alt"></i>
                    <span>Templates</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'doctors:analytics' %}">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'doctors:settings' %}">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </li>
        </ul>
    </aside>

    <main class="main-content">
        <div class="top-bar">
            <h1 class="page-title">Appointment Details</h1>
            <div class="top-bar-right">
                <a href="{% url 'doctors:appointments' %}" class="btn-secondary" style="margin-right: 15px;">
                    <i class="fas fa-arrow-left"></i> Back to Appointments
                </a>
                <a href="{% url 'accounts:logout' %}" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>

        <div class="form-container">
            <!-- Appointment Status Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <div>
                    <h2 style="margin: 0;">Appointment #{{ appointment.ticket_number }}</h2>
                    <p style="color: #7f8c8d; margin: 5px 0 0 0;">
                        Created on {{ appointment.created_at|date:"F d, Y - g:i A" }}
                    </p>
                </div>
                <div>
                    {% if appointment.status == 'pending' %}
                        <span class="status-badge status-pending" style="font-size: 16px; padding: 10px 20px;">Pending</span>
                    {% elif appointment.status == 'approved' %}
                        <span class="status-badge status-approved" style="font-size: 16px; padding: 10px 20px;">Confirmed</span>
                    {% elif appointment.status == 'completed' %}
                        <span class="status-badge" style="background: #e3f2fd; color: #1976d2; font-size: 16px; padding: 10px 20px;">Completed</span>
                    {% elif appointment.status == 'cancelled' %}
                        <span class="status-badge status-declined" style="font-size: 16px; padding: 10px 20px;">Cancelled</span>
                    {% endif %}
                </div>
            </div>

            <!-- Student Information -->
            <div class="card" style="margin-bottom: 25px;">
                <h3><i class="fas fa-user"></i> Student Information</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 15px;">
                    <div>
                        <label style="font-weight: 600; color: #7f8c8d; font-size: 13px;">Full Name</label>
                        <p style="margin: 5px 0;">{{ appointment.student.user.get_full_name }}</p>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #7f8c8d; font-size: 13px;">Student ID</label>
                        <p style="margin: 5px 0;">{{ appointment.student.student_id }}</p>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #7f8c8d; font-size: 13px;">Email</label>
                        <p style="margin: 5px 0;">{{ appointment.student.user.email }}</p>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #7f8c8d; font-size: 13px;">Phone</label>
                        <p style="margin: 5px 0;">{{ appointment.student.user.phone_number|default:"Not provided" }}</p>
                    </div>
                </div>
            </div>

            <!-- Appointment Details -->
            <div class="card" style="margin-bottom: 25px;">
                <h3><i class="fas fa-calendar-check"></i> Appointment Details</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 15px;">
                    <div>
                        <label style="font-weight: 600; color: #7f8c8d; font-size: 13px;">Service Type</label>
                        <p style="margin: 5px 0;">{{ appointment.get_service_type_display }}</p>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #7f8c8d; font-size: 13px;">Preferred Date</label>
                        <p style="margin: 5px 0;">{{ appointment.preferred_date|date:"F d, Y" }}</p>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #7f8c8d; font-size: 13px;">Preferred Time</label>
                        <p style="margin: 5px 0;">{{ appointment.get_preferred_time_slot_display }}</p>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #7f8c8d; font-size: 13px;">Assigned Doctor</label>
                        <p style="margin: 5px 0;">
                            {% if appointment.doctor %}
                                {{ appointment.doctor.get_full_name }}
                            {% else %}
                                <span style="color: #95a5a6;">Not assigned</span>
                            {% endif %}
                        </p>
                    </div>
                </div>

                {% if appointment.reason %}
                <div style="margin-top: 20px;">
                    <label style="font-weight: 600; color: #7f8c8d; font-size: 13px;">Reason for Visit</label>
                    <p style="margin: 5px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        {{ appointment.reason }}
                    </p>
                </div>
                {% endif %}

                {% if appointment.doctor_notes %}
                <div style="margin-top: 20px;">
                    <label style="font-weight: 600; color: #7f8c8d; font-size: 13px;">Doctor's Notes</label>
                    <p style="margin: 5px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        {{ appointment.doctor_notes }}
                    </p>
                </div>
                {% endif %}

                {% if appointment.status == 'cancelled' and appointment.cancellation_reason %}
                <div style="margin-top: 20px;">
                    <label style="font-weight: 600; color: #e74c3c; font-size: 13px;">
                        <i class="fas fa-times-circle"></i> Cancellation Reason
                    </label>
                    <p style="margin: 5px 0; padding: 15px; background: #fee; border-left: 4px solid #e74c3c; border-radius: 8px;">
                        {{ appointment.cancellation_reason }}
                    </p>
                    <small style="color: #7f8c8d;">
                        Cancelled on {{ appointment.cancelled_at|date:"F d, Y - g:i A" }}
                        {% if appointment.cancelled_by %}
                            by {{ appointment.cancelled_by.get_full_name }}
                        {% endif %}
                    </small>
                </div>
                {% endif %}
            </div>

            <!-- Recent Medical Records -->
            {% if medical_records %}
            <div class="card">
                <h3><i class="fas fa-notes-medical"></i> Recent Medical Records</h3>
                <div class="table-container" style="margin-top: 15px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Diagnosis</th>
                                <th>Doctor</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in medical_records %}
                            <tr>
                                <td>{{ record.visit_date|date:"M d, Y" }}</td>
                                <td>{{ record.get_record_type_display }}</td>
                                <td>{{ record.diagnosis|truncatewords:10 }}</td>
                                <td>{{ record.doctor.get_full_name }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Actions -->
            <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: 15px;">
                    {% if appointment.status == 'pending' %}
                        <a href="{% url 'doctors:approve_appointment' appointment.id %}" class="btn-primary">
                            <i class="fas fa-check"></i> Approve Appointment
                        </a>
                    {% elif appointment.status == 'approved' %}
                        <a href="{% url 'doctors:complete_appointment' appointment.id %}" class="btn-primary">
                            <i class="fas fa-check-circle"></i> Mark as Completed
                        </a>
                    {% endif %}
                    <a href="{% url 'doctors:search' %}?student_id={{ appointment.student.student_id }}" class="btn-secondary">
                        <i class="fas fa-folder-open"></i> View Full Record
                    </a>
                </div>
                
                {% if appointment.status in 'pending,approved' %}
                <div>
                    <a href="{% url 'doctors:cancel_appointment' appointment.id %}" 
                       class="btn-secondary" 
                       style="background: #e74c3c; color: white; border-color: #e74c3c;">
                        <i class="fas fa-times-circle"></i> Cancel Appointment
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </main>
</div>
{% endblock %}